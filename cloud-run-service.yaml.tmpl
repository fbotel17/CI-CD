apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: crud-api
  namespace: {{GCP_PROJECT_ID}}
spec:
  template:
    metadata:
      annotations:
        autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "3"
        run.googleapis.com/cloudsql-instances: {{DB_INSTANCE_CONNECTION_NAME}}
        # INDISPENSABLE : Active l'environnement Gen2 pour le partage de fichiers
        run.googleapis.com/execution-environment: gen2
    spec:
      # Création du volume partagé en mémoire RAM
      volumes:
        - name: shared-logs
          emptyDir:
            medium: Memory

      containers:
        # --- CONTENEUR 1 : VOTRE API NODE.JS ---
        - name: crud-api
          image: {{DOCKER_USERNAME}}/crud-api:{{VERSION}}
          env:
            - name: DB_HOST
              value: "/cloudsql/{{DB_INSTANCE_CONNECTION_NAME}}"
            - name: DB_USER
              value: "{{DB_USER}}"
            - name: DB_PASSWORD
              value: "{{DB_PASSWORD}}"
            - name: DB_NAME
              value: "{{DB_NAME}}"
          # L'API écrit ses logs ici
          volumeMounts:
            - name: shared-logs
              mountPath: /var/logs/crud
          ports:
            - containerPort: 8080

        # --- CONTENEUR 2 : FLUENT BIT ---
        - name: fluent-bit
          image: {{DOCKER_USERNAME}}/fluentbit:{{VERSION}}
          env:
            # C'est cette variable que Fluent Bit va utiliser
            - name: LOKI_HOST
              value: "{{LOKI_HOST_CLEAN}}"
          volumeMounts:
            - name: shared-logs
              mountPath: /var/logs/crud